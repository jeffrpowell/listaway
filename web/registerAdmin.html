{{define "all"}}
<div class="self-center items-center justify-center my-auto">
    <h1 class="text-3xl font-bold text-center mb-8">Listaway - Admin registration</h1>
    {{if .AdminExists}}
    <p class="text-center text-gray-600">An admin user already exists in this instance.</p>
    {{else}}
    <p class="text-center text-gray-600">Please provide the email and password that should be used for the initial admin of this instance</p>
    <form class="register-admin-form bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
                Email
            </label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="email" type="email" name="email" placeholder="Email">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="name">
                Public Name
            </label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="name" type="name" name="name" placeholder="Name">
        </div>
        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="password">
                Password
            </label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="password" type="password" name="password" placeholder="******************">
        </div>
        <div class="flex items-center justify-between">
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                Register
            </button>
            <span class="error-span text-red-500 italic hidden"></span>
        </div>
    </form>
    {{end}}
</div>
{{end}}
{{define "js"}}
<script type="text/javascript">
    async function sendData(form) {
        // Associate the FormData object with the form element
        const formData = new FormData(form);

        try {
            const response = await fetch("/admin/register", {
                method: "POST",
                headers: {
                    "Accept": "text/plain",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams(formData).toString()
            });
            if (response.status >= 400) {
                showError(response);
            } else if (response.status === 200) {
                window.location.href = response.headers.get("Location");
            }
        } catch (e) {
            console.error(e);
            showError(500);
        }
    }

    // Take over form submission
    const forms = document.querySelectorAll(".register-admin-form");
    forms.forEach(form => form.addEventListener("submit", (event) => {
        event.preventDefault();
        sendData(form);
    }));

    async function showError(response) {
        text = await response.text();
        const errorSpans = document.querySelectorAll(".error-span");
        errorSpans.forEach(errorSpan => {
            if (response.status < 500) {
                errorSpan.innerText = text;
            }
            else {
                errorSpan.innerText = "Unexpected error occurred. Please try again later.";
            }
            errorSpan.classList.remove("hidden");
        });
    }
</script>
{{end}}